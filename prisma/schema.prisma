// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tenant model for multi-tenancy support
model Tenant {
  id           String   @id @default(cuid())
  name         String // Company name
  slug         String   @unique // URL-friendly identifier
  subdomain    String?  @unique // Optional subdomain
  active       Boolean  @default(true)
  logo         String?
  primaryColor String?  @default("#3b82f6")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  users        User[]
  intervenants Intervenant[]
  mouvements   Mouvement[]

  @@index([slug])
  @@index([active])
}

// User model with Role enum (using String for SQLite compatibility)
model User {
  id              String               @id @default(cuid())
  tenantId        String
  tenant          Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name            String
  email           String
  password        String // bcrypt hashed
  role            String               @default("USER") // SUPER_ADMIN, ADMIN or USER
  active          Boolean              @default(true)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  reconciliations CashReconciliation[]

  @@unique([tenantId, email]) // Email unique per tenant
  @@index([tenantId])
  @@index([email])
}

// Intervenant model with IntervenantType enum (using String for SQLite compatibility)
model Intervenant {
  id            String         @id @default(cuid())
  tenantId      String
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name          String
  type          String // CLIENT, FOURNISSEUR, ASSOCIE, COLLABORATEUR, CAISSE_BANQUE, AUTRE
  active        Boolean        @default(true)
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  mouvements    Mouvement[]
  disbursements Disbursement[] // Renamed from advances

  @@index([tenantId])
  @@index([tenantId, type])
}

// Mouvement model with MouvementType and Modality enums (using String for SQLite compatibility)
model Mouvement {
  id                 String        @id @default(cuid())
  tenantId           String
  tenant             Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date               DateTime
  intervenantId      String
  intervenant        Intervenant   @relation(fields: [intervenantId], references: [id], onDelete: Restrict)
  type               String // ENTREE or SORTIE
  amount             Float
  reference          String?
  modality           String? // ESPECES, CHEQUE, VIREMENT, AUTRE
  category           String? // SALAIRES, ACHATS_STOCK, FRAIS_GENERAUX, AVANCES_ASSOCIES, VENTES, CHARGES_FIXES, AUTRES
  note               String?
  isDisbursement     Boolean       @default(false) // Renamed from isAdvance
  disbursementId     String? // Renamed from advanceId
  disbursement       Disbursement? @relation("DisbursementReturns", fields: [disbursementId], references: [id])
  linkedDisbursement Disbursement? @relation("DisbursementMovement")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([tenantId])
  @@index([tenantId, date])
  @@index([tenantId, intervenantId])
  @@index([tenantId, type])
  @@index([tenantId, category])
  @@index([date])
  @@index([intervenantId])
  @@index([type])
  @@index([disbursementId])
}

// Disbursement model for tracking cash outflows that require justification (replaces Advance)
model Disbursement {
  id              String          @id @default(cuid())
  tenantId        String
  mouvementId     String          @unique
  mouvement       Mouvement       @relation("DisbursementMovement", fields: [mouvementId], references: [id])
  intervenantId   String
  intervenant     Intervenant     @relation(fields: [intervenantId], references: [id], onDelete: Restrict)
  initialAmount   Float
  remainingAmount Float
  dueDate         DateTime?
  status          String          @default("OPEN") // OPEN, PARTIALLY_JUSTIFIED, JUSTIFIED
  category        String? // STOCK_PURCHASE, BANK_DEPOSIT, SALARY_ADVANCE, GENERAL_EXPENSE, OTHER
  justifications  Justification[]
  returns         Mouvement[]     @relation("DisbursementReturns")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([tenantId])
  @@index([tenantId, intervenantId])
  @@index([tenantId, status])
  @@index([intervenantId])
  @@index([status])
  @@index([dueDate])
}

// Justification model for documenting how disbursed funds were used (does NOT create cash movements)
model Justification {
  id             String       @id @default(cuid())
  tenantId       String
  disbursementId String
  disbursement   Disbursement @relation(fields: [disbursementId], references: [id], onDelete: Cascade)
  date           DateTime
  amount         Float
  category       String // Must match or be subcategory of disbursement category
  reference      String?
  note           String?
  attachments    String? // JSON array of file paths (future)
  createdBy      String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([tenantId])
  @@index([disbursementId])
  @@index([date])
}

// CashReconciliation model for tracking cash counts
model CashReconciliation {
  id                 String   @id @default(cuid())
  tenantId           String
  date               DateTime
  theoreticalBalance Float
  physicalCount      Float
  gap                Float
  note               String?
  userId             String
  user               User     @relation(fields: [userId], references: [id])
  createdAt          DateTime @default(now())

  @@index([tenantId])
  @@index([tenantId, date])
  @@index([date])
}

// Alert model for system notifications
model Alert {
  id          String    @id @default(cuid())
  tenantId    String
  type        String // DEBT_THRESHOLD, LOW_CASH, OVERDUE_DISBURSEMENT, LONG_OPEN_DISBURSEMENT, HIGH_OUTSTANDING_DISBURSEMENTS, RECONCILIATION_GAP
  title       String
  message     String
  severity    String // INFO, WARNING, ERROR
  relatedId   String?
  dismissed   Boolean   @default(false)
  dismissedAt DateTime?
  dismissedBy String?
  createdAt   DateTime  @default(now())

  @@index([tenantId])
  @@index([tenantId, dismissed])
  @@index([dismissed])
  @@index([type])
  @@index([createdAt])
}

// Settings model for tenant-specific configuration
model Settings {
  id                                String   @id @default(cuid())
  tenantId                          String   @unique
  debtThreshold                     Float    @default(10000)
  minCashBalance                    Float    @default(5000)
  reconciliationGapThreshold        Float    @default(500)
  defaultAdvanceDueDays             Int      @default(30)
  disbursementOutstandingThreshold  Float    @default(10000)
  disbursementOpenDaysWarning       Int      @default(30)
  companyName                       String   @default("Fluxio")
  companyLogo                       String?
  currency                          String   @default("TND")
  alertsEnabled                     Boolean  @default(true)
  categoriesEnabled                 Boolean  @default(true)
  advancesEnabled                   Boolean  @default(true)
  updatedAt                         DateTime @updatedAt

  @@index([tenantId])
}

// CustomCategory model for tenant-specific movement categories
model CustomCategory {
  id        String   @id @default(cuid())
  tenantId  String
  code      String // Unique code for the category (e.g., SALAIRES, CUSTOM_1)
  label     String // Display label (e.g., "Salaires", "Marketing")
  color     String   @default("#6B7280") // Hex color code for visual distinction
  active    Boolean  @default(true)
  isDefault Boolean  @default(false) // Whether this is a default system category
  sortOrder Int      @default(0) // For custom ordering
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, active])
}
